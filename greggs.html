
<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8" http-equiv="Cache-control" content="NO-CACHE">

  <title>Checkout</title>

  <link rel='shortcut icon' type='image/x-icon' href='favicon.ico' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel="stylesheet" href="css/style-greggs.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113051118-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-113051118-1');
</script>
<!-- END Global site tag (gtag.js) - Google Analytics -->


</head>

<style>
  #checkoutError {
      width: 100%;
      padding: 50px 0;
      text-align: center;
      background-color: red;
      margin-top: 20px;
      display:none;     
  }

  #PDContent img {
    position: absolute;
    top: 0px;
    right: 15px;
  }

</style>

<body>
  <br/>

  <img  height="100" width="200" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJcAAABPCAMAAADRLKcJAAAAn1BMVEUAVY7////9tigAU40ASYgAUIzM2+YAQ4UARYYATIoATosAR4e8zdzc6O+yxNYATJLxtDf/uRoAW5UATpAlY5EoW4wdYpdUcIr/vR2assqJjHzLplnWqU73+vx9nLsAUZFggqoAO4GovtNRfadGeKWOq8Xn8PYALHs5bJxmjbJse4GxmmfEpF54hIJ0k7WGo8Drs0E4Z4+ek3JDaImAhH2od+r3AAADvklEQVRoge2Wa5ebOAyGzcjC2AY6IW06dEsCJKGhl6S77f//bSuJS5Jpe3bopz09fr5gJb68liXZSgUCgUAgEAgEAoFAIBAIBP5wAODlXZ/ZCn7954vYvWJo5Jq/6+sfmOiiUMYjz+wNkXgnK2gz4oee1mBRoLHTSLHdZCNZYPRSWd//Yr7h7h/+fp72Br6OqyiKuvxEq0MaM+llQ4vpMh5JubeDY0Ydq+yCvIWrfWQbdM9Wd1zos9371cPDw+rdunjkxtNbHGSpOJoorXLZZGytMulkVLSY3lezeaDB9t527Wjk9j+UPNf1ILpeFY/SGHUhyarKvt7GPDtgRjsuSxZ0giSNqlxoFbg9/RZv63PZRSmNneyebQDsyVfb+lLFbpnDJl3rO126pMmLBJ1ttgenWFfcaN1s2Xukq2u8QGuRJ4/GOvRYcgzBYCN6XVIA6DyqTh71plh8jj/xFxRV1G0Gz/E+RRetgqcqakWXB5BstWc6ITOsaTnYxBYT+OA0+fZk77LzpbqeVqvVk8QXN0QX1uQXTjbUDEz+SsiNF8e6DDLAZxqdeIjjjpZ13NhOWRqR7UHjUl347R3zBvAjf7/vxEd0Xj1Nhb2k3UbiK89TDrqNaMmEUtMfGXtU59yxFZt9M9lw4izI2sPSOqGQq9aa5tqtGfmNd7nn3LpIKomuga53KpnzMfdq1GU6tuNEdVHG55dko42HeEzqZUcJ+JqgWAI1NtSghwSQv9I8G3V1OS1QctBwPlJyEr1j//AQ26ZpRToo7LthZ2nONs3h9m03FJgl7D49Mh938F4ar3lbHF9twg3dHEddcYPkC451yUcJPFQ+HuIJrDbUJ7Hky4MI1R860UU7p1Sls3TLdI11dczHIe5hU1EgyUR21qXtdsgGycdxOEdiKvkIlnVcbdUMuvj8wI/HvUTXr+pXVnhEd/WXB5uJc27qFwIFVHRsqF7Zhv0FXM9Krl9O/AX+eNKoqe7ES/31M11zvT+31ewv5ah4p15d631+QFcP9Z1vBvbPvW2gjapLfSaxl9+7h57rurkfq0mXMvTj2V3zkZND1/N9GKX67n6M0mSeZvE99PmJ+bKGr9L4e3pP6F7eE1V6pvJJ74mW1qSkj1Pl5/dEXOP8foi69iBRN70nOi5aYC/Dc2JhmaA32xtmRx7i72YuzEAPKnp/JUYuIp/ImpgYCiGdTA8w6Q3WAL+/ONpu7EaKvBjKLJUlyoZ3KUyN6z8vv9Z+eK/e2r/zXA0EAoFAIBAIBAKBQCAQCPxP+Rfpqki74/jmHwAAAABJRU5ErkJggg==">

  <div id="PDContent">
    <img height="45" width="110" src="https://iqm7l1pa7bn3d42rc278rat5-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/logo-pagerduty.svg"/>
  </div>

  
  <h1>Lunch Time Checkout</h1>

<br/>
Name &amp; email: <input type="text" name="customerName" id="customer-name" value="Enter your name here..." onfocus="if(this.value=='Enter your name here...') this.value='';"><br>

<br/>


<div class="shopping-cart">

  <div class="column-labels">
    <label class="product-image">Image</label>
    <label class="product-details">Product</label>
    <label class="product-price">Price</label>
    <label class="product-quantity">Quantity</label>
    <label class="product-removal">Remove</label>
    <label class="product-line-price">Total</label>
  </div>

  <div class="product">
    <div class="product-image">
      <!-- <img src="https://www.att.com/catalog/en/skus/images/apple-iphone%20x-space%20gray-450x350.png"> -->
      <img src="https://i.guim.co.uk/img/media/0e4338b4782e861fcd6c062cedb57350576947a7/0_73_4062_2437/master/4062.jpg?width=620&quality=45&auto=format&fit=max&dpr=2&s=f7d264c443d1feec1a10e8c44848c879">
    </div>
    <div class="product-details">
      <div class="product-title">Vegan sausage rolls</div>
      <p class="product-description">The most hotly debated sausage roll since, well... the sausage roll. Our new vegan friendly sausage roll has been designed to mirror some of the sausage rollâ€™s classic features including 96 layers of light and crisp puff pastry but instead we wrap it around our own bespoke Quorn filling.  

        The launch follows strong consumer demand, including a petition by PETA last year, which was signed by more than 20,000 people.</p>
    </div>
    <div class="product-price">3.50</div>
    <div class="product-quantity">
      <input type="number" value="2" min="1">
    </div>
    <div class="product-removal">
      <button class="remove-product">
        Remove
      </button>
    </div>
    <div class="product-line-price">7.00</div>
  </div>

  <div class="product">
    <div class="product-image">
      <img src="https://s3.eu-west-2.amazonaws.com/greggs-prod-cms/public/Uploads/79a59fbea6/Tomato-Soup-3-v3_640.jpg">
    </div>
    <div class="product-details">
      <div class="product-title">Tomato Soup</div>
      <p class="product-description">There's nothing as warming on a cold winters day as a good serving of Cream of Tomato Soup.

        Pop into your local Greggs today and warm up with our delicious Cream of Tomato Soup.
        
        In association with Public Health England's One You campaign, you can enjoy this alongside the egg mayonnaise sandwich and cloudy lemonade shown in the 'you may also like' section for under 600 calories - 580 to be exact!</p>
    </div>
    <div class="product-price">4.00</div>
    <div class="product-quantity">
      <input type="number" value="1" min="1">
    </div>
    <div class="product-removal">
      <button class="remove-product">
        Remove
      </button>
    </div>
    <div class="product-line-price">4.00</div>
  </div>

  <div class="totals">
    <div class="totals-item">
      <label>Subtotal</label>
      <div class="totals-value" id="cart-subtotal">11.00</div>
    </div>
    <div class="totals-item">
      <label>VAT (5%)</label>
      <div class="totals-value" id="cart-tax">0.55</div>
    </div>
    <div class="totals-item">
      <label>Shipping</label>
      <div class="totals-value" id="cart-shipping">1.00</div>
    </div>
    <div class="totals-item totals-item-total">
      <label>Grand Total</label>
      <div class="totals-value" id="cart-total">12.55</div>
    </div>
  </div>
      
      <button id="checkoutButton" class="checkout" onclick="completeCheckout()">Checkout</button>
  </div>


<div id="PDinfo">
  Try and drive our on-call Engineer crazy! or can you?...
</div>

<div id="checkoutError">
  <b>Error in Checkout - Unable to complete your order</b> 
  <br/>"Connection to data source updateOrderDB can not be established! 
  <br/>Reason: Invalid operation. The connection is closed. - complete stack
  <br/>at System.Data.SqlClient.SqlConnection.GetOpenConnection()
  <br/>at System.Data.SqlClient.SqlConnection.get_Parser()
  <br/>at System.Data.SqlClient.SqlConnection.Open()", Please try later
</div>

<script>

  //################################################################################
  //Function to Generate a GUID - Not used now - this was to get a unique key for Dedup'ing
  function guid() {
    function s4() {
      return Math.floor((1 + Math.random()) * 0x10000)
        .toString(16)
        .substring(1);
    }
    return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
      s4() + '-' + s4() + s4() + s4();
  }
  //################################################################################


  //################################################################################
  //Grab the Params from the URL in this case the Service Key
  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
  }
  //################################################################################

  //################################################################################
  //Clears the Checkout error back to default
  function updateResponsePanel()
  {
    var x = document.getElementById("checkoutError");
    x.style.display = "block";

    var y = document.getElementById("PDinfo");
    y.style.display = "none";

    document.getElementById("checkoutButton").innerHTML = "Checkout";

  }
  //################################################################################


  //################################################################################
  //The Main function under the button
  function completeCheckout() {

    //Capture the customer name
    node = document.getElementById('customer-name'),
    customerName = node.value

    //Check the input makes sense
    if (customerName == "Enter your name here...") 
    {
      alert('Please enter your name and email to complete the order');
      return;
    }
    if (customerName == "") 
    {
      alert('Who are you???');
      return;
    }

    //Grab the Service key of use Tim's default one!
    var serviceKey = getParameterByName('service_key');
    if (!serviceKey) serviceKey = "999845c2635841589098d7fe425b0d0d";

    //Clear the error pane if showing
    var x = document.getElementById("checkoutError");
    x.style.display = "none";

    //Set the Button to something happening
    document.getElementById("checkoutButton").innerHTML = "Working";
    
    //Update the panel eventually - simulating an end system response
    setTimeout(updateResponsePanel, 4000);

    //Get the Order Value and a Dedup key based on Customer Name and the Minute of the Button click 
    //(someone clicks multiple times = caught one)
    //They return later - we trigger a new alert 
    var node = document.getElementById('cart-total'),
    orderValue = node.innerHTML
    var date = new Date();  
    dedupKey = customerName + date.getMinutes()


    // Requires jQuery
    //Build the JSON payload to send
    var eventObject = '{ ' + 
        ' "client_url": "https://rpm.newrelic.com/accounts/1818495/applications/105833762", ' +
        ' "service_key"\: "' + serviceKey + '", ' +
        ' "incident_key"\: "' + dedupKey + '", ' +
        ' "client"\: "New Relic", ' +
        ' "vendor"\: "New Relic", ' +
        ' "event_type"\: "trigger", ' +
        ' "contexts"\: [ ' +
        ' {  ' +
            ' "src": "https://s3.eu-west-2.amazonaws.com/www.timchinchen.co.uk/DemoImages/NRErrors2.png", ' +
            ' "alt": "Snapshot of metric", ' +
            ' "href": "http://www.timchinchen.co.uk/DemoImages/NRErrors1.png", ' +
            ' "type": "image" ' +
        ' }, ' +
    
        ' { ' +   
        ' "text": "Conference URL (Zoom)", ' +
        ' "href": "https://pagerduty.zoom.us/j/5080555253", ' +
        ' "type": "link" ' +
        ' }, ' +
    
      '{' +
      '  "text": "Conference Dial (Zoom)",  ' +
      '  "href": "tel:+442036950088,,5080555253#",  ' +
      '  "type": "link"  ' +
      '},' +
    '{' +
      ' "text": "Monitor Status", ' +
      ' "href": "https://appp.datadoghq.com/monitors#72563?to_ts=1452282540000&group=host%3Aprod-web-xdb09&from_ts=1452281340000", ' +
      ' "type": "link" ' +
    '},' +
    '{ ' +
    ' "text": "New Relic - Permalink", ' +
    '  "href": "https://rpm.newrelic.com/accounts/1818495/applications/105833762?tw%5Bend%5D=1518535392&tw%5Bstart%5D=1518528373", ' +
    '  "type": "link" ' +
    ' } ' +
    ' ], ' +
  ' "details": { ' +
    ' "body": "[Critical] Increased response time detected on the Checkout page affecting ' + customerName + ', High Error rates <br/> Object Reference Not Set and ADO.NET Connection pool exceeded errors detected" , ' +   
    ' "Order Value": ' + orderValue + ', ' +
    ' "priority": "High", ' +
    ' "title": "[Critical] Increased response time detected on the Checkout page, High Error rates  affecting ' + customerName + '", ' +
    ' "event_id": "8125363154448140714", ' +
    ' "tags": "aws-prod, base, env:prod, host:farnsworth, monitor, pd_az:us-west-2c, production, xdb, xtradb", ' +
    ' "Customer": "'+ customerName + '" ' +
    ' }, ' +
  ' "description": "[Critical] Increased response time detected on the Checkout page, High Error rates" ' +
  '}' 

  console.log(eventObject)


  //    ' "Customer Name": ' + customerName + ', ' +


    //var settings = {
    //  "url": "https://events.pagerduty.com/generic/2010-04-15/create_event.json",
    //  "method": "POST",
    //  "data":  eventObject,
    //  "headers": {
    //    "Accept": "application/vnd.pagerduty+json;version=2",
    //    "Authorization": "Token token=V_uHsBDv3G2NxyimTYVg",
    //  }
    //};

    //$.ajax(settings).done(function (response) {
    //  console.log(response);
    //  $("#responseText").text(JSON.stringify(response));
    //});

    //$.ajax({
    //  type: "POST",
    //  url: "https://events.pagerduty.com/generic/2010-04-15/create_event.json",
    //  data: eventObject,
    //  success: null,
    //  dataType: "json"
    //});

    //Send!!!
    $.ajax({
      method: "POST",
      url: "https://events.pagerduty.com/generic/2010-04-15/create_event.json",
      data: eventObject
    })
      .done(function( msg ) {
        //alert( "Data Saved: " + msg );
    });

    //Update the panel eventually - simulating an end system response
    setTimeout(sendZabbix, 5000);
    //Update the panel eventually - simulating an end system response
    setTimeout(sendLowRevenueWarning, 5000);

  }




 //################################################################################
 function sendZabbix()
  {
    console.log('Send to Zabbix');

    
    //Grab the Service key of use Tim's default one!
    var serviceKey = getParameterByName('service_key');
    if (!serviceKey) serviceKey = "999845c2635841589098d7fe425b0d0d";

    var eventObject = ' { ' +
    '   "payload": {     ' +
    '     "summary": "java.lang.OutOfMemoryError: Java heap space",   ' +
    '     "source": "Zabbix",   ' +
    '     "severity": "warning",   ' +
    '     "location" : "prod",   ' +
    '     "component": "Zabbix",   ' +
    '     "group": "Zabbix,Production,eCommerce,Checkout-Tier",   ' +
    '     "class": "Zabbix" },   ' +
    '   	"routing_key": "' + serviceKey + '",   ' +
    '   	"dedup_key": "Zabbixdedupkey",   ' +
    '    	"event_action": "trigger",   ' +
    '   	"client": "View in Zabbix",   ' +
    '   	"client_url": "www.zabbix.com",   ' +
    '   	"images": [   ' +
    '   	    {   ' +
    '   	      "src": "https://chart.googleapis.com/chart?chs=600x400&chd=t:6,2,9,5,2,5,7,4,8,2,1&cht=lc&chds=a&chxt=y&chm=D,0033FF,0,0,5,1",   ' +
    '   	      "href": "https://acme.pagerduty.com",   ' +
    '   	      "alt": "This is a sample link"  ' +
    '   	  }  ' +
    '   	]  ' +
    '   }'


    console.log(eventObject);

    $.ajax({
      method: "POST",
      url: "https://events.pagerduty.com/v2/enqueue",
      data: eventObject
    })
      .done(function( msg ) {
        //alert( "Data Saved: " + msg );
    });

    return;
  }
  //################################################################################


//################################################################################
function sendLowRevenueWarning()
  {

    console.log('Send Low Revenue Warning');

    
    //Grab the Service key of use Tim's default one!
    var serviceKey = getParameterByName('service_key');
    if (!serviceKey) serviceKey = "999845c2635841589098d7fe425b0d0d";

    var eventObject = ' { ' +
    '   "payload": {     ' +
    '     "summary": "Low Revenue detected compared to normal",   ' +
    '     "source": "Prometheus",   ' +
    '     "severity": "warning",   ' +
    '     "location" : "prod",   ' +
    '     "component": "Prometheus",   ' +
    '     "group": "Prometheus,Production,eCommerce,Checkout-Tier",   ' +
    '     "class": "Prometheus" },   ' +
    '   	"routing_key": "' + serviceKey + '",   ' +
    '   	"dedup_key": "Prometheusdedupkey",   ' +
    '    	"event_action": "trigger",   ' +
    '   	"client": "View in Prometheus",   ' +
    '   	"client_url": "www.Prometheus.com",   ' +
    '   	"images": [   ' +
    '   	    {   ' +
    '   	      "src": "https://logz.io/wp-content/uploads/2017/03/memory-graph.png",   ' +
    '   	      "href": "https://logz.io/wp-content/uploads/2017/03/memory-graph.png",   ' +
    '   	      "alt": "This is a sample link"  ' +
    '   	  }  ' +
    '   	]  ' +
    '   }'


    console.log(eventObject);

    $.ajax({
      method: "POST",
      url: "https://events.pagerduty.com/v2/enqueue",
      data: eventObject
    })
      .done(function( msg ) {
        //alert( "Data Saved: " + msg );
    });

    return;
  }
  //################################################################################





  </script>



<script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script  src="js/index.js"></script>
</body>
</html>
